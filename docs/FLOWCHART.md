# 🗺 기능 흐름도

## 🔹 1. 잔액 충전 / 조회

```mermaid
flowchart TD
    A1[사용자 잔액 충전 요청] --> A2[잔액 API 호출]
    A2 --> A3[사용자 ID 검증]
    A3 -->|유효하지 않음| A4[응답: 잘못된 사용자]
    A3 -->|유효함| A5[DB에서 현재 잔액 조회]
    A5 --> A6[입력 금액을 잔액에 더함]
    A6 --> A7[업데이트된 잔액 DB에 저장]
    A7 --> A8[최신 잔액 응답 반환]
```

* 비고: 사용자 잔액은 DB 내 별도 테이블에서 관리되며, 충전 시에는 트랜잭션으로 처리

## 🔹 2. 상품 조회

```mermaid
flowchart TD
    B1[사용자 상품 목록 요청] --> B2[상품 API 호출]
    B2 --> B3[Redis에 캐시 존재 여부 확인]
    B3 -->|캐시 있음| B4[Redis에서 상품 목록 조회]
    B3 -->|캐시 없음| B5[DB에서 전체 상품 조회]
    B5 --> B6[상품 정보 Redis에 캐시]
    B4 --> B7[응답 반환]
    B6 --> B7
```

* 비고: 재고 정보는 최신 상태로 보장되어야 하며, 캐싱이 필요할 경우 주의

## 🔹 3. 선착순 쿠폰 발급

```mermaid
flowchart TD
    C1[쿠폰 발급 요청] --> C2[Redis Lock 시도]
    C2 -->|실패| C3[중복/마감 응답]
    C2 -->|성공| C4[보유 여부 확인]
    C4 -->|보유 중| C5[이미 발급 응답]
    C4 -->|미보유| C6[쿠폰 생성 및 저장]
    C6 --> C7[Redis 발급 수량 감소]
    C7 --> C8[발급 완료 응답]
```

## 🔹 4. 주문 / 결제 처리

```mermaid
flowchart TD
    D1[사용자 주문 요청] --> D2[주문 API 호출]
    D2 --> D3[사용자 잔액 조회]
    D3 --> D4[총 주문 금액 계산]
    D4 --> D5[쿠폰 유효성 검증]
    D5 --> D6[상품 재고 확인 및 락 처리]
    D6 -->|재고 부족| D7[주문 실패 응답: 재고 부족]
    D6 -->|재고 충분| D8[할인 적용 후 최종 결제 금액 계산]
    D8 --> D9[사용자 잔액 차감]
    D9 -->|잔액 부족| D10[주문 실패 응답: 잔액 부족]
    D9 -->|잔액 충분| D11[주문 정보 및 주문 항목 저장]
    D11 --> D12[쿠폰 사용 처리]
    D12 --> D13[주문 이벤트 비동기 전송]
    D13 --> D14[주문 성공 응답 반환]
```

* 비고: 동시성 고려를 위해 재고 감소와 잔액 차감은 락 또는 트랜잭션 처리 필수

## 🔹 5. 인기 상품 조회

```mermaid
flowchart TD
    E1[사용자 인기 상품 조회 요청] --> E2[인기 상품 API 호출]
    E2 --> E3[최근 3일간 주문 데이터 통계 조회]
    E3 -->|통계 없음| E4[응답: 통계 정보 없음]
    E3 -->|데이터 존재| E5[Top 5 상품 추출]
    E5 --> E6[상품 상세 정보 병합]
    E6 --> E7[인기 상품 리스트 응답 반환]
```

* 비고: 통계 집계는 실시간 또는 주기적 배치 전략 가능. 캐싱 전략 고려
