# 📄 E-Commerce 주문 서비스 요구사항 정의

## 🎯 서비스 목표

사용자는 사전에 충전한 잔액으로 상품을 여러 개 주문할 수 있으며, 선착순으로 할인 쿠폰을 발급받아 결제 시 사용할 수 있습니다. 
결제 성공 시 주문 정보를 외부 데이터 플랫폼에 실시간 전송하고, 최근 3일간 가장 인기 있는 상품을 집계하여 제공합니다.

---

## 📌 필수 기능

### ✅ 1. 잔액 충전 및 조회 API

* 사용자는 자신의 계좌에 일정 금액을 충전할 수 있습니다.
* 현재 잔액은 조회가 가능해야 합니다.
* 사용자의 잔액 정보는 동시 업데이트를 고려해 정확하게 반영되어야 합니다.

**제약 조건**

* 동시 요청 시에도 정합성이 깨지지 않아야 합니다.
* 잔액 충전 및 차감은 트랜잭션 내에서 안전하게 처리되어야 합니다.
---

### ✅ 2. 상품 조회 API

* 전체 상품 목록을 조회할 수 있어야 하며, 각 상품은 다음 정보를 포함해야 합니다.

  * 상품 ID
  * 상품 이름
  * 가격
  * 남은 재고 수량

**제약 조건**

* 수량은 실시간으로 반영되어야 하며, 캐시로 인한 지연이 없어야 합니다.
* 재고는 마이너스가 되면 안 되며, 동시 주문 시 정확하게 감소되어야 합니다.
---

### ✅ 3. 선착순 쿠폰 API

* 사용자는 선착순으로 쿠폰을 발급받을 수 있습니다.
* 쿠폰은 전체 발급 수량에 제한이 있으며, 선착순으로 처리되어야 합니다.
* 이미 발급받은 사용자는 다시 발급받을 수 없습니다.
* 유효한 쿠폰은 주문 시 사용 가능합니다.

**제약 조건**

* 중복 발급 방지를 위한 Redis 분산 Lock 또는 atomic operation 필요
* 한 유저당 쿠폰 1매 제한
* 발급된 쿠폰 수량이 실시간으로 반영되어야 함
---

### ✅ 4. 주문 및 결제 API

* 사용자는 여러 개의 상품을 동시에 주문할 수 있습니다.
* 총 결제 금액은 (상품 가격 × 수량)의 합에서 할인 쿠폰이 적용된 값입니다.
* 결제는 사전에 충전된 잔액으로 처리됩니다.
* 결제 성공 시 다음 처리를 동시 수행합니다.

  * 잔액 차감
  * 재고 차감
  * 쿠폰 사용 처리
  * 주문 정보 저장
  * 외부 데이터 플랫폼으로 주문 정보 전송

**제약 조건**

* 잔액 부족, 재고 부족, 쿠폰 미적용 시 실패
* 모든 처리 과정은 트랜잭션 단위로 묶여야 함
* 외부 전송은 내부 로직과 분리되어 비동기 처리 (Kafka, Queue, Event 등)
---

### ✅ 5. 인기 상품 조회 API

* 최근 3일간 가장 많이 판매된 상품 Top 5를 조회합니다.
* 결과는 다음 정보를 포함합니다.

  * 상품 ID
  * 상품 이름
  * 가격
  * 판매 수량

**제약 조건**

* 정렬 기준은 판매 수량 기준이며, 동률일 경우 상품 ID 오름차순
* 통계 계산은 실시간으로 처리되거나, 주기적 배치/캐싱으로 보완 가능

---

## ⚠️ 시스템 제약사항 및 고려사항

### ✅ 데이터 정합성

* 재고 감소, 잔액 차감, 쿠폰 사용 등의 중요한 변경은 **정합성 유지**가 필수
* 동시에 여러 사용자가 같은 상품을 주문해도 문제가 발생하지 않아야 함

### ✅ 동시성

* 선착순 쿠폰 발급 및 주문 시 Redis Lock 또는 DB 락을 통한 처리가 필요

### ✅ 외부 시스템 연동

* 주문 데이터는 외부 데이터 플랫폼에 **실시간 전송**해야 하며,
* 장애가 발생해도 **내부 주문 처리에는 영향이 없어야 함** (비동기 처리)

---

## 🧪 테스트 조건

* 단위 테스트에서 쿠폰 발급, 잔액 차감, 재고 감소 등의 주요 로직을 검증
* 통합 테스트에서는 동시 요청에 대한 처리 검증 (MockMvc, TestContainers 등)
